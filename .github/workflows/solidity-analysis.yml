name: Solidity Static Analysis

on: # 触发条件
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs: # 作业
  analyze:
    runs-on: ubuntu-latest
    
    steps: # 步骤
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Slither
        run: |
          python -m pip install --upgrade pip
          pip install slither-analyzer
          
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          
      - name: Install dependencies
        run: |
          npm init -y
          npm install @chainlink/contracts@1.2.0 --save-exact  # 使用特定版本
          npm install @openzeppelin/contracts@5.0.2 --save-exact
          # 清理缓存以避免冲突
          npm cache clean --force
          
      - name: Install Solc
        uses: ethereum/solc-installer@v2
        with:
          version: 0.8.25  # 匹配你的合约 pragma 版本，调整为实际版本

      - name: Install Solhint
        run: npm install -g solhint
        
      - name: Run Slither analysis
        run: |
          slither . --fail-low --exclude-informational --solc-remaps "@chainlink/contracts/=node_modules/@chainlink/contracts/" --solc-version 0.8.19
          # 确保与你的合约版本匹配

      - name: Run Solhint analysis
        run: solhint 'contracts/**/*.sol'